services:
  # MongoDB service
  mongo_db:
    container_name: dealerships_services_container
    image: mongo:latest
    ports:
      - 27018:27017
    restart: always
    volumes:
      - mongo_data:/data/db

  # Database Node API service
  database_api:
    build:
        context: ./server/database
        dockerfile: Dockerfile
    image: nodeapp_mongo
    ports:
      - 3030:3030
    depends_on:
      - mongo_db
    environment:
      # Ensure the application Node.js actually uses this variable
      MONGO_URI: "mongodb://mongo_db:27017/dealerships_db"

  # Cars Inventory Node api service
  cars_inventory_api:
    build:
        context: ./server/carsInventory
        dockerfile: Dockerfile
    image: nodeapp_carsinventory
    ports:
      - 3050:3050
    depends_on: 
      - mongo_db
      - database_api
    restart: always
    environment:
      # Connect to MongoDB via the service name defined in this docker-compose file
      MONGO_URI: "mongodb://mongo_db:27017/dealerships_db"
      # URL for the database API (if necessary)
      DATABASE_API_URL: "http://database_api:3030"
 
  # Sentiment Analyzer Microservice (Python / Flask - Port 5000)
  sentiment_analyzer:
    build:
      # The 'build' instruction should point to the folder containing the Dockerfile
        context: ./server/djangoapp/microservices
        dockerfile: Dockerfile
    container_name: sentiment_analyzer_app
    ports:
      - "5000:5000"
    restart: always

  # Django Backend (main application service - Port 8000)
  django_backend:
    build:
      # The Dockerfile is at the root of 'server'
      context: ./server
      dockerfile: Dockerfile
    container_name: django_app
    # Command to run the Django development server
    # command: python manage.py runserver 0.0.0.0:8000 # <-- Removed, because the Dockerfile
    #                                                        runs Gunicorn instead
    volumes:
      # Mount the source code for the development convenience
      - .:/app
    ports:
      - "8000:8000"
    depends_on:
      # Ensure that all the microservices and the database are ready before starting Django
      - mongo_db
      - database_api
      - cars_inventory_api
      - sentiment_analyzer
    environment:
      # Environment variables for Django to connect to other services
      # URL variable for the database API service (former port 3030)
      BACKEND_URL: "http://database_api:3030/"
      # URL variable for the cars inventory API service (former port 3050)
      SEARCHCARS_URL: "http://cars_inventory_api:3050/"
      # URL variable for the sentiment analyzer service (former port 5000)
      SENTIMENT_URL: "http://sentiment_analyzer:5000/"  # Note the trailing slash

  # Frontend service (React - Port 3000)
  frontend:
    build:
      # Point to the folder containing the Dockerfile for the frontend
      context: ./server/frontend
      dockerfile: Dockerfile
    container_name: frontend_app
    volumes:
      # Mount the source code for development convenience (synchronize files)
      - ./frontend:/app
      - /app/node_modules # Exclude node_modules to avoid conflicts
    ports:
      - "3000:3000"
    depends_on:
      - django_backend  # Ensure Django backend is running before starting frontend
    environment:
      # React calls Django via the port exposed on the host machine (localhost:8000)
      # It is the URL that the browser will call from the user computer
      REACT_APP_DJANGO_URL: "http://localhost:8000/"

volumes:
  mongo_data: {}